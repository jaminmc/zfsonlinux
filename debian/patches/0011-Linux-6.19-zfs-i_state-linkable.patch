From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: JaminMc <1310376+jaminmc@users.noreply.github.com>
Date: Wed, 28 Jan 2026 00:00:00 +0000
Subject: [PATCH] Linux 6.19: fix i_state access for I_LINKABLE

Linux 6.19 changes inode->i_state to a structured type and requires using
inode_state_read_once() helpers. OpenZFS was directly bit-testing i_state,
which fails to compile.

Keep compatibility with older kernels by using the legacy i_state bitmask
access when building against kernels older than 6.19.

---
 module/os/linux/zfs/zfs_vnops_os.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/module/os/linux/zfs/zfs_vnops_os.c b/module/os/linux/zfs/zfs_vnops_os.c
--- a/module/os/linux/zfs/zfs_vnops_os.c
+++ b/module/os/linux/zfs/zfs_vnops_os.c
@@ -70,6 +70,7 @@
 #include <sys/zpl.h>
 #include <sys/zil.h>
 #include <sys/sa_impl.h>
+#include <linux/version.h>
 #include <linux/mm_compat.h>
 
 /*
@@ -3513,7 +3514,12 @@
 	boolean_t	is_tmpfile = 0;
 	uint64_t	txg;
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 19, 0)
+	is_tmpfile = (sip->i_nlink == 0 &&
+	    (inode_state_read_once(sip) & I_LINKABLE));
+#else
 	is_tmpfile = (sip->i_nlink == 0 && (sip->i_state & I_LINKABLE));
+#endif
 
 	ASSERT(S_ISDIR(ZTOI(tdzp)->i_mode));
 
